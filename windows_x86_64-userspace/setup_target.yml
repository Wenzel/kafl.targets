- name: Setup target
  hosts: all
  vars:
    vcvars_path: "{{ ansible_env['ProgramFiles(x86)'] }}\\Microsoft Visual Studio\\2017\\BuildTools\\VC\\Auxiliary\\Build\\vcvars64.bat"
    dest_path: "{{ ansible_env.USERPROFILE }}\\Desktop"
    wdk_include_km_path: "C:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.17763.0\\km"
    wdk_lib_path: "C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.17763.0\\km\\x64"
    ntoskrnllib_path: "C:\\Program Files (x86)\\Windows Kits\\10\\Lib\\10.0.17763.0\\km\\x64\\ntoskrnl.lib"
  tasks:
    - name: Set default value for target_harness
      set_fact:
        target_harness: 'userspace'
      when: target_harness is undefined

    - name: Setup userspace harness target
      block:
        - name: Upload sources
          win_copy:
            src: bin/userspace
            dest: "{{ dest_path }}"

        - name: Setup target to run at user login
          win_shortcut:
            src: "{{ ansible_env.USERPROFILE }}\\Desktop\\selffuzz_test.exe"
            dest: "{{ ansible_env.APPDATA }}\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\kafl_target.lnk"
      when: target_harness == 'userspace'
